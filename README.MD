# OpenIM on GKE - One-Click Deployment

ä¸€é”®éƒ¨ç½² OpenIM åˆ° Google Kubernetes Engine (GKE) çš„å®Œæ•´è§£å†³æ–¹æ¡ˆï¼Œä½¿ç”¨ OpenTofu/Terraform + Helmï¼Œé‡‡ç”¨é«˜æ€§èƒ½ç»„ä»¶æ›¿æ¢æ–¹æ¡ˆã€‚

Deploy OpenIM to Google Kubernetes Engine (GKE) with a single command, using OpenTofu/Terraform + Helm with high-performance component replacements.

## ğŸ¯ Project Overview / é¡¹ç›®æ¦‚è¿°

This project provides a production-ready, one-click deployment solution for OpenIM on GKE with the following architecture:

æœ¬é¡¹ç›®æä¾›äº†ä¸€ä¸ªç”Ÿäº§å°±ç»ªçš„ OpenIM on GKE ä¸€é”®éƒ¨ç½²æ–¹æ¡ˆï¼Œå…·æœ‰ä»¥ä¸‹æ¶æ„ï¼š

### Component Replacements / ç»„ä»¶æ›¿æ¢

| Standard Component | Replacement | Reason / åŸå›  |
|-------------------|-------------|--------------|
| **Kafka** | **Redpanda** | Simpler, faster, Kafka API compatible / æ›´ç®€å•ã€æ›´å¿«ã€Kafka API å…¼å®¹ |
| **Redis** | **Dragonfly** | 25x faster, Redis protocol compatible / 25å€é€Ÿåº¦æå‡ã€Redis åè®®å…¼å®¹ |
| **MinIO** | **SeaweedFS** | Better for small files, S3 API compatible / å°æ–‡ä»¶æ€§èƒ½æ›´å¥½ã€S3 API å…¼å®¹ |
| **MySQL** | **MySQL** | Official chart / å®˜æ–¹ chart |

**Key Principle / æ ¸å¿ƒåŸåˆ™**: **NO CODE CHANGES REQUIRED** - All replacements use standard APIs / æ— éœ€ä¿®æ”¹ OpenIM ä»£ç  - æ‰€æœ‰æ›¿æ¢ä½¿ç”¨æ ‡å‡† API

## ğŸ“ Directory Structure / ç›®å½•ç»“æ„

```
openim-gke/
â”œâ”€â”€ tofu/                           # OpenTofu/Terraform infrastructure code
â”‚   â”œâ”€â”€ main.tf                     # GKE cluster configuration
â”‚   â”œâ”€â”€ variables.tf                # Configurable parameters
â”‚   â”œâ”€â”€ outputs.tf                  # Cluster outputs (kubeconfig)
â”‚   â””â”€â”€ providers.tf                # GCP provider configuration
â”‚
â”œâ”€â”€ helm/                           # Helm charts for all components (numbered for installation order)
â”‚   â”œâ”€â”€ 10-ingress-nginx/          # NGINX Ingress Controller
â”‚   â”‚   â”œâ”€â”€ values.yaml            # Ingress configuration
â”‚   â”‚   â””â”€â”€ README.md              # Installation guide
â”‚   â”‚
â”‚   â”œâ”€â”€ 20-redpanda/               # Redpanda (Kafka replacement)
â”‚   â”‚   â”œâ”€â”€ values.yaml            # Redpanda configuration
â”‚   â”‚   â””â”€â”€ README.md              # Installation & troubleshooting
â”‚   â”‚
â”‚   â”œâ”€â”€ 30-dragonfly/              # Dragonfly (Redis replacement)
â”‚   â”‚   â”œâ”€â”€ Chart.yaml             # Custom minimal Helm chart
â”‚   â”‚   â”œâ”€â”€ values.yaml            # Dragonfly configuration
â”‚   â”‚   â”œâ”€â”€ templates/             # Kubernetes manifests
â”‚   â”‚   â””â”€â”€ README.md              # Installation & troubleshooting
â”‚   â”‚
â”‚   â”œâ”€â”€ 40-seaweedfs/              # SeaweedFS (MinIO replacement)
â”‚   â”‚   â”œâ”€â”€ values.yaml            # SeaweedFS configuration
â”‚   â”‚   â””â”€â”€ README.md              # Installation & troubleshooting
â”‚   â”‚
â”‚   â””â”€â”€ 90-openim/                 # OpenIM Server Application
â”‚       â”œâ”€â”€ values.yaml            # OpenIM with all integrations
â”‚       â””â”€â”€ README.md              # Complete deployment guide
â”‚
â”œâ”€â”€ envs/                           # Environment configuration
â”‚   â””â”€â”€ dev.tfvars                 # Development environment variables
â”‚
â”œâ”€â”€ .gitignore                      # Git ignore file
â””â”€â”€ README.md                       # This file (main entry point)
```

## ğŸš€ Quick Start / å¿«é€Ÿå¼€å§‹

### Prerequisites / å‰ç½®æ¡ä»¶

1. **GCP Account** with billing enabled / GCP è´¦å·å¹¶å¯ç”¨è®¡è´¹
2. **gcloud CLI** installed and configured / å®‰è£…å¹¶é…ç½® gcloud CLI
   ```bash
   gcloud auth login
   gcloud config set project YOUR_PROJECT_ID
   ```
3. **kubectl** installed / å®‰è£… kubectl
4. **Helm 3** installed / å®‰è£… Helm 3
5. **OpenTofu** or **Terraform** installed / å®‰è£… OpenTofu æˆ– Terraform
   ```bash
   # Install OpenTofu (recommended)
   curl -Lo tofu.tar.gz https://github.com/opentofu/opentofu/releases/latest/download/tofu_*_linux_amd64.tar.gz
   tar -xzf tofu.tar.gz && sudo mv tofu /usr/local/bin/
   
   # Or install Terraform
   # wget https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
   # unzip terraform_1.6.0_linux_amd64.zip && sudo mv terraform /usr/local/bin/
   ```

### Installation Steps / å®‰è£…æ­¥éª¤

#### Step 1: Configure Variables / é…ç½®å˜é‡

Edit `envs/dev.tfvars` with your GCP project settings:

ç¼–è¾‘ `envs/dev.tfvars` å¡«å…¥ä½ çš„ GCP é¡¹ç›®è®¾ç½®ï¼š

```bash
# Required: Replace with your GCP project ID
project_id = "your-gcp-project-id"

# Optional: Adjust these based on your needs
region         = "us-central1"
cluster_name   = "openim-dev-cluster"
node_count     = 3
machine_type   = "e2-standard-4"
```

#### Step 2: Deploy Infrastructure / éƒ¨ç½²åŸºç¡€è®¾æ–½

```bash
cd tofu/

# Initialize Terraform/OpenTofu
tofu init  # or: terraform init

# Review the execution plan
tofu plan -var-file=../envs/dev.tfvars

# Apply the configuration (create GKE cluster)
tofu apply -var-file=../envs/dev.tfvars

# Configure kubectl to use the new cluster
gcloud container clusters get-credentials openim-dev-cluster \
  --region us-central1 \
  --project your-gcp-project-id
```

**â±ï¸ Time:** ~10-15 minutes for GKE cluster creation / GKE é›†ç¾¤åˆ›å»ºéœ€è¦ 10-15 åˆ†é’Ÿ

#### Step 3: Deploy Components with Helm / ä½¿ç”¨ Helm éƒ¨ç½²ç»„ä»¶

**Important:** Install components in order (numbered directories) / é‡è¦ï¼šæŒ‰é¡ºåºå®‰è£…ç»„ä»¶ï¼ˆç¼–å·ç›®å½•ï¼‰

```bash
# 1. Install NGINX Ingress Controller
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update
helm install ingress-nginx ingress-nginx/ingress-nginx \
  --namespace ingress-nginx --create-namespace \
  --values helm/10-ingress-nginx/values.yaml

# Wait for external IP
kubectl get svc -n ingress-nginx -w

# 2. Install Redpanda (Kafka replacement)
helm repo add redpanda https://charts.redpanda.com
helm repo update
helm install redpanda redpanda/redpanda \
  --namespace redpanda --create-namespace \
  --values helm/20-redpanda/values.yaml

# Wait for Redpanda to be ready
kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=redpanda -n redpanda --timeout=300s

# 3. Install Dragonfly (Redis replacement)
helm install dragonfly helm/30-dragonfly \
  --namespace dragonfly --create-namespace

# Wait for Dragonfly to be ready
kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=dragonfly -n dragonfly --timeout=300s

# 4. Install SeaweedFS (MinIO replacement)
helm repo add seaweedfs https://seaweedfs.github.io/seaweedfs/helm
helm repo update
helm install seaweedfs seaweedfs/seaweedfs \
  --namespace seaweedfs --create-namespace \
  --values helm/40-seaweedfs/values.yaml

# Wait for SeaweedFS to be ready
kubectl wait --for=condition=ready pod -l app.kubernetes.io/component=master -n seaweedfs --timeout=300s

# Create S3 bucket for OpenIM
kubectl port-forward -n seaweedfs svc/seaweedfs-filer 8333:8333 &
aws --endpoint-url http://localhost:8333 s3 mb s3://openim

# 5. Install OpenIM Server
helm repo add openim https://openimsdk.github.io/helm-charts
helm repo update
helm install openim openim/openim-server \
  --namespace openim --create-namespace \
  --values helm/90-openim/values.yaml

# Wait for OpenIM to be ready
kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=openim -n openim --timeout=600s
```

**â±ï¸ Time:** ~15-20 minutes for all components / æ‰€æœ‰ç»„ä»¶éƒ¨ç½²éœ€è¦ 15-20 åˆ†é’Ÿ

**Total deployment time:** ~30 minutes from start to finish / ä»å¼€å§‹åˆ°ç»“æŸæ€»å…±çº¦ 30 åˆ†é’Ÿ

## âœ… Verification Checklist / éªŒè¯æ¸…å•

Use this checklist to verify your deployment:

ä½¿ç”¨æ­¤æ¸…å•éªŒè¯æ‚¨çš„éƒ¨ç½²ï¼š

### Infrastructure / åŸºç¡€è®¾æ–½

```bash
# Check cluster status
kubectl get nodes
kubectl cluster-info

# Check storage classes
kubectl get storageclass
```

- [ ] GKE cluster is running / GKE é›†ç¾¤è¿è¡Œä¸­
- [ ] All nodes are Ready / æ‰€æœ‰èŠ‚ç‚¹å°±ç»ª
- [ ] Storage class available / å­˜å‚¨ç±»å¯ç”¨

### Components / ç»„ä»¶

```bash
# Check all namespaces
kubectl get pods --all-namespaces

# Or check each component
kubectl get pods -n ingress-nginx
kubectl get pods -n redpanda
kubectl get pods -n dragonfly
kubectl get pods -n seaweedfs
kubectl get pods -n openim
```

- [ ] Ingress NGINX running with external IP / Ingress NGINX è¿è¡Œå¹¶æœ‰å¤–éƒ¨ IP
- [ ] Redpanda cluster healthy (3/3 pods) / Redpanda é›†ç¾¤å¥åº·ï¼ˆ3/3 podsï¼‰
- [ ] Dragonfly running (2/2 pods) / Dragonfly è¿è¡Œï¼ˆ2/2 podsï¼‰
- [ ] SeaweedFS all components running / SeaweedFS æ‰€æœ‰ç»„ä»¶è¿è¡Œ
- [ ] OpenIM all pods running / OpenIM æ‰€æœ‰ pods è¿è¡Œ

### Connectivity / è¿é€šæ€§

```bash
# Test Redpanda (Kafka)
kubectl exec -it redpanda-0 -n redpanda -- rpk cluster info

# Test Dragonfly (Redis)
kubectl run redis-test --rm -it --restart=Never --image=redis:alpine -- \
  redis-cli -h dragonfly.dragonfly.svc.cluster.local ping

# Test SeaweedFS (S3)
kubectl run s3-test --rm -it --restart=Never --image=amazon/aws-cli -- \
  --endpoint-url=http://seaweedfs-filer.seaweedfs.svc.cluster.local:8333 \
  s3 ls

# Test OpenIM API
kubectl port-forward -n openim svc/openim-api 10002:10002
curl http://localhost:10002/health
```

- [ ] Redpanda accepts Kafka connections / Redpanda æ¥å— Kafka è¿æ¥
- [ ] Dragonfly accepts Redis connections / Dragonfly æ¥å— Redis è¿æ¥
- [ ] SeaweedFS S3 API accessible / SeaweedFS S3 API å¯è®¿é—®
- [ ] OpenIM API responds / OpenIM API å“åº”

### API Testing / API æµ‹è¯•

```bash
# Port-forward OpenIM API
kubectl port-forward -n openim svc/openim-api 10002:10002

# Test health
curl http://localhost:10002/health

# Test version
curl http://localhost:10002/version
```

- [ ] Health check returns 200 / å¥åº·æ£€æŸ¥è¿”å› 200
- [ ] Version endpoint works / ç‰ˆæœ¬ç«¯ç‚¹å·¥ä½œ
- [ ] User registration works / ç”¨æˆ·æ³¨å†Œå·¥ä½œ
- [ ] User login works / ç”¨æˆ·ç™»å½•å·¥ä½œ

### WebSocket Testing / WebSocket æµ‹è¯•

```bash
# Port-forward message gateway
kubectl port-forward -n openim svc/openim-msggateway 10001:10001

# Test with websocat (install if needed: apt-get install websocat)
echo '{"type":"ping"}' | websocat ws://localhost:10001/ws
```

- [ ] WebSocket connection establishes / WebSocket è¿æ¥å»ºç«‹
- [ ] Messages can be sent / æ¶ˆæ¯å¯ä»¥å‘é€
- [ ] Real-time delivery works / å®æ—¶æŠ•é€’å·¥ä½œ

### Storage Testing / å­˜å‚¨æµ‹è¯•

```bash
# Upload a test file via OpenIM API
# This tests the SeaweedFS integration
# (Use OpenIM client or API documentation for specific endpoints)
```

- [ ] File upload works / æ–‡ä»¶ä¸Šä¼ å·¥ä½œ
- [ ] Files stored in SeaweedFS / æ–‡ä»¶å­˜å‚¨åœ¨ SeaweedFS
- [ ] Files can be retrieved / æ–‡ä»¶å¯ä»¥æ£€ç´¢

### Logs and Observability / æ—¥å¿—å’Œå¯è§‚æµ‹æ€§

```bash
# Check logs for each component
kubectl logs -n openim -l app=openim-api --tail=50
kubectl logs -n redpanda redpanda-0 --tail=50
kubectl logs -n dragonfly dragonfly-0 --tail=50
kubectl logs -n seaweedfs -l app.kubernetes.io/component=filer --tail=50
```

- [ ] No error messages in logs / æ—¥å¿—ä¸­æ— é”™è¯¯æ¶ˆæ¯
- [ ] Metrics endpoints accessible / æŒ‡æ ‡ç«¯ç‚¹å¯è®¿é—®
- [ ] All components reporting healthy / æ‰€æœ‰ç»„ä»¶æŠ¥å‘Šå¥åº·

## ğŸ”§ Configuration Guide / é…ç½®æŒ‡å—

### Single Entry Point / å•ä¸€å…¥å£

All configuration starts from `envs/dev.tfvars`:

æ‰€æœ‰é…ç½®ä» `envs/dev.tfvars` å¼€å§‹ï¼š

```hcl
# Infrastructure settings
project_id   = "your-project"
region       = "us-central1"
cluster_name = "openim-dev"

# Node pool settings
node_count     = 3      # Initial nodes
min_node_count = 2      # Minimum for autoscaling
max_node_count = 10     # Maximum for autoscaling
machine_type   = "e2-standard-4"  # 4 vCPU, 16GB RAM

# For production, adjust:
# - machine_type to "e2-standard-8" or larger
# - node_count to at least 5
# - min_node_count to 3
```

### Adjusting Resources / è°ƒæ•´èµ„æº

**For Development / å¼€å‘ç¯å¢ƒ:**
- machine_type: `e2-standard-4` (4 vCPU, 16GB)
- node_count: 3
- Total: ~50 GB RAM, 12 vCPU

**For Production / ç”Ÿäº§ç¯å¢ƒ:**
- machine_type: `e2-standard-8` (8 vCPU, 32GB)
- node_count: 5
- Total: ~160 GB RAM, 40 vCPU

### Component-Specific Configuration / ç»„ä»¶ç‰¹å®šé…ç½®

Each component has its own `values.yaml`:

æ¯ä¸ªç»„ä»¶éƒ½æœ‰è‡ªå·±çš„ `values.yaml`ï¼š

- **Redpanda** (`helm/20-redpanda/values.yaml`): Adjust replicas, storage size
- **Dragonfly** (`helm/30-dragonfly/values.yaml`): Adjust memory limits
- **SeaweedFS** (`helm/40-seaweedfs/values.yaml`): Adjust volume storage size
- **OpenIM** (`helm/90-openim/values.yaml`): Adjust all service replicas

## ğŸ“Š Component Comparison / ç»„ä»¶å¯¹æ¯”

### Advantages of Replacements / æ›¿æ¢æ–¹æ¡ˆçš„ä¼˜åŠ¿

#### Redpanda vs Kafka

| Feature | Kafka | Redpanda |
|---------|-------|----------|
| Architecture | Requires ZooKeeper | Single binary |
| Setup Complexity | High | Low |
| Resource Usage | High (JVM) | Low (C++) |
| Performance | Good | Excellent |
| Kafka Compatibility | 100% | 100% |
| Operational Overhead | High | Low |

**Pros / ä¼˜ç‚¹:**
- 10x faster topic creation / 10å€é€Ÿåº¦åˆ›å»º topic
- 5x lower latency / 5å€é™ä½å»¶è¿Ÿ
- 30% less memory / 30% æ›´å°‘å†…å­˜
- No ZooKeeper dependency / æ—  ZooKeeper ä¾èµ–

**Cons / ç¼ºç‚¹:**
- Newer technology / è¾ƒæ–°æŠ€æœ¯
- Smaller ecosystem / è¾ƒå°ç”Ÿæ€

#### Dragonfly vs Redis

| Feature | Redis | Dragonfly |
|---------|-------|-----------|
| Threading | Single-threaded | Multi-threaded |
| Performance | Baseline | 25x faster |
| Memory Usage | Baseline | 30% less |
| Redis Compatibility | 100% | ~95% |
| Vertical Scaling | Limited | Excellent |

**Pros / ä¼˜ç‚¹:**
- 25x better throughput / 25å€ååé‡æå‡
- Multi-core utilization / å¤šæ ¸åˆ©ç”¨
- Lower memory footprint / æ›´å°å†…å­˜å ç”¨
- Built-in snapshots / å†…ç½®å¿«ç…§

**Cons / ç¼ºç‚¹:**
- Not 100% Redis compatible / ä¸æ˜¯ 100% Redis å…¼å®¹
- Newer project / è¾ƒæ–°é¡¹ç›®

#### SeaweedFS vs MinIO

| Feature | MinIO | SeaweedFS |
|---------|-------|-----------|
| Architecture | Distributed locks | Simpler |
| Small Files | Good | Excellent |
| Large Files | Excellent | Good |
| S3 Compatibility | ~100% | ~99% |
| Resource Usage | Moderate | Low |

**Pros / ä¼˜ç‚¹:**
- Better for many small files / æ›´é€‚åˆå¤§é‡å°æ–‡ä»¶
- Simpler architecture / æ›´ç®€å•æ¶æ„
- Lower resource usage / æ›´ä½èµ„æºä½¿ç”¨
- Native file system support / åŸç”Ÿæ–‡ä»¶ç³»ç»Ÿæ”¯æŒ

**Cons / ç¼ºç‚¹:**
- Fewer S3 features / æ›´å°‘ S3 åŠŸèƒ½
- Smaller ecosystem / è¾ƒå°ç”Ÿæ€

### When NOT to Use Replacements / ä½•æ—¶ä¸ä½¿ç”¨æ›¿æ¢æ–¹æ¡ˆ

Consider using standard components if:

å¦‚æœç¬¦åˆä»¥ä¸‹æ¡ä»¶ï¼Œè€ƒè™‘ä½¿ç”¨æ ‡å‡†ç»„ä»¶ï¼š

- **Very large scale** (100+ brokers for Kafka) / è¶…å¤§è§„æ¨¡
- **Need 100% compatibility** with all Redis/S3 features / éœ€è¦ 100% å…¼å®¹æ€§
- **Large existing ecosystem integration** / å¤§é‡ç°æœ‰ç”Ÿæ€ç³»ç»Ÿé›†æˆ
- **Risk-averse production environment** / é£é™©è§„é¿çš„ç”Ÿäº§ç¯å¢ƒ

## ğŸ”„ Upgrade and Failover / å‡çº§å’Œæ•…éšœåˆ‡æ¢

### Upgrading Components / å‡çº§ç»„ä»¶

```bash
# Update Helm repositories
helm repo update

# Upgrade a specific component (example: Redpanda)
helm upgrade redpanda redpanda/redpanda \
  --namespace redpanda \
  --values helm/20-redpanda/values.yaml

# Check upgrade status
helm status redpanda -n redpanda

# Rollback if needed
helm rollback redpanda -n redpanda
```

### Failover Procedures / æ•…éšœåˆ‡æ¢ç¨‹åº

#### Database Failover / æ•°æ®åº“æ•…éšœåˆ‡æ¢

If using MySQL replication:

å¦‚æœä½¿ç”¨ MySQL å¤åˆ¶ï¼š

```bash
# Promote a replica to primary
kubectl exec -it mysql-secondary-0 -n openim -- mysql -u root -p
# Execute: STOP SLAVE; RESET SLAVE ALL;

# Update OpenIM configuration to point to new primary
helm upgrade openim openim/openim-server \
  --namespace openim \
  --set mysql.external.host=mysql-secondary.openim.svc.cluster.local
```

#### Redpanda Failover / Redpanda æ•…éšœåˆ‡æ¢

Redpanda has built-in HA with 3 replicas:

Redpanda å†…ç½®é«˜å¯ç”¨ï¼Œ3ä¸ªå‰¯æœ¬ï¼š

```bash
# Check cluster status
kubectl exec -it redpanda-0 -n redpanda -- rpk cluster info

# Redpanda automatically elects new leaders
# No manual intervention needed
```

#### Dragonfly Failover / Dragonfly æ•…éšœåˆ‡æ¢

```bash
# Dragonfly StatefulSet automatically restarts failed pods
# Data is persisted to PVs and restored on restart

# Check pod status
kubectl get pods -n dragonfly

# If needed, manually restart
kubectl rollout restart statefulset dragonfly -n dragonfly
```

## ğŸ› ï¸ Troubleshooting / æ•…éšœæ’æŸ¥

### Common Issues / å¸¸è§é—®é¢˜

#### Issue 1: GKE Cluster Creation Fails / GKE é›†ç¾¤åˆ›å»ºå¤±è´¥

```bash
# Check quota limits
gcloud compute project-info describe --project=YOUR_PROJECT_ID

# Check service APIs are enabled
gcloud services list --enabled --project=YOUR_PROJECT_ID
```

**Solution / è§£å†³æ–¹æ¡ˆ:**
- Enable required APIs: `gcloud services enable container.googleapis.com`
- Request quota increase if needed / å¦‚éœ€è¦ï¼Œè¯·æ±‚é…é¢å¢åŠ 

#### Issue 2: Pods Stuck in Pending / Pods å¡åœ¨ Pending

```bash
# Check pod status
kubectl describe pod <pod-name> -n <namespace>

# Check node resources
kubectl top nodes
```

**Solution / è§£å†³æ–¹æ¡ˆ:**
- Increase node count: Update `envs/dev.tfvars` and re-apply / å¢åŠ èŠ‚ç‚¹æ•°
- Use larger machine type / ä½¿ç”¨æ›´å¤§çš„æœºå™¨ç±»å‹

#### Issue 3: Connection Refused Between Components / ç»„ä»¶é—´è¿æ¥è¢«æ‹’

```bash
# Test DNS resolution
kubectl run -it --rm debug --image=busybox --restart=Never -- \
  nslookup redpanda.redpanda.svc.cluster.local

# Test connectivity
kubectl run -it --rm debug --image=nicolaka/netshoot --restart=Never -- \
  nc -zv redpanda.redpanda.svc.cluster.local 9092
```

**Solution / è§£å†³æ–¹æ¡ˆ:**
- Verify service names in `values.yaml` / éªŒè¯ values.yaml ä¸­çš„æœåŠ¡å
- Check network policies / æ£€æŸ¥ç½‘ç»œç­–ç•¥
- Ensure components are in Running state / ç¡®ä¿ç»„ä»¶å¤„äºè¿è¡ŒçŠ¶æ€

#### Issue 4: Ingress Not Getting External IP / Ingress æœªè·å–å¤–éƒ¨ IP

```bash
# Check ingress controller service
kubectl get svc -n ingress-nginx ingress-nginx-controller

# Check events
kubectl get events -n ingress-nginx --sort-by='.lastTimestamp'
```

**Solution / è§£å†³æ–¹æ¡ˆ:**
- Wait 5-10 minutes for GCP Load Balancer creation / ç­‰å¾… 5-10 åˆ†é’Ÿè®© GCP è´Ÿè½½å‡è¡¡å™¨åˆ›å»º
- Check GCP quotas for load balancers / æ£€æŸ¥ GCP è´Ÿè½½å‡è¡¡å™¨é…é¢

### Debug Commands / è°ƒè¯•å‘½ä»¤

```bash
# View logs
kubectl logs -n <namespace> <pod-name> --tail=100 -f

# Execute commands in pod
kubectl exec -it <pod-name> -n <namespace> -- /bin/sh

# Check resource usage
kubectl top pods -n <namespace>
kubectl top nodes

# Check events
kubectl get events -n <namespace> --sort-by='.lastTimestamp'

# Describe resource
kubectl describe <resource-type> <resource-name> -n <namespace>
```

## ğŸ” Security Considerations / å®‰å…¨è€ƒè™‘

### Default Credentials (MUST CHANGE) / é»˜è®¤å‡­è¯ï¼ˆå¿…é¡»æ›´æ”¹ï¼‰

The following default credentials are used and **MUST BE CHANGED** in production:

ä»¥ä¸‹é»˜è®¤å‡­è¯å¿…é¡»åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ›´æ”¹ï¼š

| Component | Default Credentials | Location |
|-----------|---------------------|----------|
| MySQL | root: `openIM123`, user: `openIM/openIM123` | `helm/90-openim/values.yaml` |
| SeaweedFS S3 | Access: `admin`, Secret: `admin123` | `helm/40-seaweedfs/values.yaml` |
| Redpanda | No auth (internal only) | Enable SASL for production |
| Dragonfly | No auth (internal only) | Enable password for production |

### Security Hardening / å®‰å…¨åŠ å›º

1. **Enable TLS/SSL** for all external endpoints / ä¸ºæ‰€æœ‰å¤–éƒ¨ç«¯ç‚¹å¯ç”¨ TLS/SSL
2. **Network Policies** to restrict pod-to-pod communication / ç½‘ç»œç­–ç•¥é™åˆ¶ pod é—´é€šä¿¡
3. **RBAC** for Kubernetes access control / RBAC è¿›è¡Œ Kubernetes è®¿é—®æ§åˆ¶
4. **Pod Security Policies** / Pod å®‰å…¨ç­–ç•¥
5. **Secrets Management** using Google Secret Manager or HashiCorp Vault / ä½¿ç”¨ Google Secret Manager æˆ– HashiCorp Vault ç®¡ç†å¯†é’¥

## ğŸ“ TODOs and Customization / å¾…åŠäº‹é¡¹å’Œè‡ªå®šä¹‰

### Before Production / ç”Ÿäº§å‰å¿…åš

- [ ] **Change all default passwords** / æ›´æ”¹æ‰€æœ‰é»˜è®¤å¯†ç 
- [ ] **Configure actual domain name** / é…ç½®å®é™…åŸŸå
- [ ] **Enable TLS with cert-manager** / ä½¿ç”¨ cert-manager å¯ç”¨ TLS
- [ ] **Enable authentication** for Redpanda and Dragonfly / ä¸º Redpanda å’Œ Dragonfly å¯ç”¨è®¤è¯
- [ ] **Set up monitoring** (Prometheus + Grafana) / è®¾ç½®ç›‘æ§
- [ ] **Configure alerting** / é…ç½®å‘Šè­¦
- [ ] **Set up backup strategy** / è®¾ç½®å¤‡ä»½ç­–ç•¥
- [ ] **Document runbooks** / æ–‡æ¡£åŒ–è¿ç»´æ‰‹å†Œ
- [ ] **Load testing** / è´Ÿè½½æµ‹è¯•
- [ ] **Security audit** / å®‰å…¨å®¡è®¡

### Optional Enhancements / å¯é€‰å¢å¼º

- [ ] **Multi-region deployment** / å¤šåŒºåŸŸéƒ¨ç½²
- [ ] **Disaster recovery plan** / ç¾éš¾æ¢å¤è®¡åˆ’
- [ ] **CI/CD pipeline** / CI/CD æµæ°´çº¿
- [ ] **Service mesh** (Istio/Linkerd) / æœåŠ¡ç½‘æ ¼
- [ ] **Advanced monitoring** (Elastic Stack) / é«˜çº§ç›‘æ§
- [ ] **Cost optimization** / æˆæœ¬ä¼˜åŒ–

### Known Limitations / å·²çŸ¥é™åˆ¶

1. **OpenIM Helm Chart Compatibility**: This configuration is based on the OpenIM Helm chart structure. If the official chart changes fields, update `helm/90-openim/values.yaml` accordingly.
   
   OpenIM Helm Chart å…¼å®¹æ€§ï¼šæ­¤é…ç½®åŸºäº OpenIM Helm chart ç»“æ„ã€‚å¦‚æœå®˜æ–¹ chart æ›´æ”¹å­—æ®µï¼Œè¯·ç›¸åº”æ›´æ–° values.yamlã€‚

2. **Dragonfly Helm Chart**: We provide a minimal custom chart as there's no mature official Helm chart. Update if official chart becomes available.
   
   Dragonfly Helm Chartï¼šæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæœ€å°çš„è‡ªå®šä¹‰ chartï¼Œå› ä¸ºæ²¡æœ‰æˆç†Ÿçš„å®˜æ–¹ Helm chartã€‚å¦‚æœå®˜æ–¹ chart å¯ç”¨ï¼Œè¯·æ›´æ–°ã€‚

3. **SeaweedFS S3 Compatibility**: ~99% compatible, some advanced S3 features may not work.
   
   SeaweedFS S3 å…¼å®¹æ€§ï¼šçº¦ 99% å…¼å®¹ï¼ŒæŸäº›é«˜çº§ S3 åŠŸèƒ½å¯èƒ½ä¸å·¥ä½œã€‚

4. **PostgreSQL Support**: Not officially supported by OpenIM. Requires custom configuration and testing.
   
   PostgreSQL æ”¯æŒï¼šOpenIM å®˜æ–¹ä¸æ”¯æŒã€‚éœ€è¦è‡ªå®šä¹‰é…ç½®å’Œæµ‹è¯•ã€‚

## ğŸ”— Useful Links / æœ‰ç”¨é“¾æ¥

### Official Documentation / å®˜æ–¹æ–‡æ¡£

- **OpenIM**: https://github.com/openimsdk/open-im-server
- **OpenIM Helm Charts**: https://github.com/openimsdk/helm-charts
- **Redpanda**: https://docs.redpanda.com/
- **Dragonfly**: https://www.dragonflydb.io/docs
- **SeaweedFS**: https://github.com/seaweedfs/seaweedfs/wiki
- **GKE**: https://cloud.google.com/kubernetes-engine/docs

### Tools / å·¥å…·

- **kubectl**: https://kubernetes.io/docs/tasks/tools/
- **Helm**: https://helm.sh/docs/
- **OpenTofu**: https://opentofu.org/docs/
- **gcloud CLI**: https://cloud.google.com/sdk/docs/install

## ğŸ¤ Contributing / è´¡çŒ®

Contributions are welcome! Please:

æ¬¢è¿è´¡çŒ®ï¼è¯·ï¼š

1. Fork this repository / Fork æ­¤ä»“åº“
2. Create a feature branch / åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. Make your changes / è¿›è¡Œæ›´æ”¹
4. Test thoroughly / å½»åº•æµ‹è¯•
5. Submit a pull request / æäº¤ pull request

## ğŸ“„ License / è®¸å¯è¯

This project is provided as-is for deploying OpenIM on GKE. Please refer to the individual components for their respective licenses.

æ­¤é¡¹ç›®æŒ‰åŸæ ·æä¾›ç”¨äºåœ¨ GKE ä¸Šéƒ¨ç½² OpenIMã€‚è¯·å‚è€ƒå„ä¸ªç»„ä»¶çš„ç›¸åº”è®¸å¯è¯ã€‚

## ğŸ’¬ Support / æ”¯æŒ

For issues and questions:

é—®é¢˜å’Œç–‘é—®ï¼š

1. Check component READMEs in `helm/*/README.md` / æ£€æŸ¥ helm/*/README.md ä¸­çš„ç»„ä»¶ README
2. Review troubleshooting section above / æŸ¥çœ‹ä¸Šé¢çš„æ•…éšœæ’æŸ¥éƒ¨åˆ†
3. Open an issue in this repository / åœ¨æ­¤ä»“åº“ä¸­å¼€å¯ issue
4. Consult official documentation for each component / æŸ¥é˜…æ¯ä¸ªç»„ä»¶çš„å®˜æ–¹æ–‡æ¡£

---

**Ready to deploy? Start with Step 1 above! / å‡†å¤‡éƒ¨ç½²ï¼Ÿä»ä¸Šé¢çš„æ­¥éª¤ 1 å¼€å§‹ï¼**

**Questions? Check the detailed README in each `helm/*/` directory! / æœ‰ç–‘é—®ï¼ŸæŸ¥çœ‹æ¯ä¸ª helm/*/ ç›®å½•ä¸­çš„è¯¦ç»† READMEï¼**
