# Dragonfly 配置
# Dragonfly 的自定义 Helm Chart - 兼容 Redis 协议的内存存储

# 副本配置
replicaCount: 2

image:
  repository: docker.dragonflydb.io/dragonflydb/dragonfly
  pullPolicy: IfNotPresent
  tag: "v1.36.1"  # 最新稳定版本 (2026年1月)

# 服务配置
service:
  type: ClusterIP
  port: 6379  # 标准 Redis 端口
  annotations: {}

# 资源限制
resources:
  limits:
    cpu: 2000m
    memory: 4Gi
  requests:
    cpu: 500m
    memory: 2Gi

# Dragonfly 特定配置
dragonfly:
  # 最大内存使用量（单位：MB）
  maxMemory: 2048
  
  # 线程数（如果不设置则自动检测）
  # threads: 4
  
  # 快照配置
  snapshot:
    enabled: true
    dir: /data
    interval: 300  # 每5分钟保存一次
  
  # 持久化存储
  persistence:
    enabled: true
    storageClass: standard
    size: 10Gi
    accessMode: ReadWriteOnce

# Pod 注解
podAnnotations: {}

# Pod 安全上下文
podSecurityContext:
  fsGroup: 999

# 安全上下文
securityContext:
  runAsNonRoot: true
  runAsUser: 999
  capabilities:
    drop:
      - ALL

# 节点选择器
nodeSelector: {}

# 容忍度
tolerations: []

# 高可用性亲和性规则
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - dragonfly
          topologyKey: kubernetes.io/hostname

# 存活性探针
livenessProbe:
  tcpSocket:
    port: 6379
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

# 就绪性探针
readinessProbe:
  exec:
    command:
      - /bin/sh
      - -c
      - dragonfly --version
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

# ==============================================================================
# 安装命令：
# helm install dragonfly helm/30-dragonfly \
#   --namespace dragonfly --create-namespace
# ==============================================================================

# OpenIM 的连接详情：
# 主机：dragonfly.dragonfly.svc.cluster.local
# 端口：6379

# 相比 Redis 的优势：
# - 在某些工作负载中吞吐量提高 25 倍
# - 内存使用减少 30%
# - 垂直可扩展性（多线程）
# - 完全兼容 Redis API（无需修改代码）
# - 内置快照和复制功能

# 生产环境需要考虑：
# - 启用密码认证
# - 设置 TLS 加密
# - 配置主从复制
# - 根据工作负载调整内存限制
