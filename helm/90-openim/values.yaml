# OpenIM 服务器配置
# 此配置将 OpenIM 与所有自定义替换组件集成：
# - Kafka → Redpanda
# - Redis → Dragonfly
# - MinIO → SeaweedFS
# - MySQL（官方 chart）

# ==============================================================================
# 全局配置
# ==============================================================================
global:
  # 域名配置
  # 待办：替换为您的实际域名
  domain: "openim.example.com"
  
  # 镜像配置
  image:
    registry: "ghcr.io/openimsdk"
    pullPolicy: IfNotPresent

# ==============================================================================
# MySQL 数据库配置（依赖）
# ==============================================================================
mysql:
  # 使用官方 MySQL Helm chart
  enabled: true
  auth:
    rootPassword: "openIM123"
    database: "openIM_v3"
    username: "openIM"
    password: "openIM123"
  
  primary:
    persistence:
      enabled: true
      storageClass: standard
      size: 20Gi
    
    resources:
      limits:
        cpu: 1000m
        memory: 2Gi
      requests:
        cpu: 500m
        memory: 1Gi

  # 架构（单机或复制）
  architecture: standalone
  
  # 生产环境考虑使用复制：
  # architecture: replication
  # secondary:
  #   replicaCount: 1

# ==============================================================================
# Kafka 配置（使用 Redpanda）
# ==============================================================================
kafka:
  # 禁用默认的 Kafka chart
  enabled: false
  
  # 外部 Kafka 配置（Redpanda）
  external:
    enabled: true
    # Redpanda 服务地址
    brokers:
      - "redpanda-0.redpanda.redpanda.svc.cluster.local:9092"
      - "redpanda-1.redpanda.redpanda.svc.cluster.local:9092"
      - "redpanda-2.redpanda.redpanda.svc.cluster.local:9092"
    
    # 或使用 Redpanda 服务（负载均衡）
    # brokers:
    #   - "redpanda.redpanda.svc.cluster.local:9092"

# ==============================================================================
# Redis 配置（使用 Dragonfly）
# ==============================================================================
redis:
  # 禁用默认的 Redis chart
  enabled: false
  
  # 外部 Redis 配置（Dragonfly）
  external:
    enabled: true
    # Dragonfly 服务地址
    host: "dragonfly.dragonfly.svc.cluster.local"
    port: 6379
    # 默认无密码（生产环境需设置）
    password: ""

# ==============================================================================
# MinIO/对象存储配置（使用 SeaweedFS）
# ==============================================================================
minio:
  # 禁用默认的 MinIO chart
  enabled: false

# 对象存储配置（SeaweedFS S3 API）
object:
  # 启用对象存储
  enable: true
  
  # 使用兼容 MinIO 的配置（SeaweedFS S3 API）
  apiURL: "http://seaweedfs-filer.seaweedfs.svc.cluster.local:8333"
  
  minio:
    # SeaweedFS S3 端点
    endpoint: "http://seaweedfs-filer.seaweedfs.svc.cluster.local:8333"
    
    # OpenIM 的存储桶名称
    bucket: "openim"
    
    # S3 凭证（待办：生产环境需更改！）
    accessKeyID: "admin"
    secretAccessKey: "admin123"
    
    # 区域（SeaweedFS 可以使用任何值）
    region: "us-east-1"
    
    # 签名版本
    signVersion: "v4"

# ==============================================================================
# OpenIM 服务器组件
# ==============================================================================

# API 服务器
api:
  replicaCount: 2
  
  resources:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 500m
      memory: 512Mi
  
  service:
    type: ClusterIP
    port: 10002

# 消息网关
msggateway:
  replicaCount: 2
  
  resources:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 500m
      memory: 512Mi
  
  service:
    type: ClusterIP
    port: 10001

# 消息传输
msgtransfer:
  replicaCount: 2
  
  resources:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 500m
      memory: 512Mi

# 推送
push:
  replicaCount: 2
  
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

# 认证
auth:
  replicaCount: 2
  
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

# 会话
conversation:
  replicaCount: 2
  
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

# 好友
friend:
  replicaCount: 2
  
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

# 群组
group:
  replicaCount: 2
  
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

# 消息
msg:
  replicaCount: 2
  
  resources:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 500m
      memory: 512Mi

# 第三方服务
third:
  replicaCount: 2
  
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

# 用户
user:
  replicaCount: 2
  
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

# ==============================================================================
# Ingress 配置
# ==============================================================================
ingress:
  enabled: true
  className: "nginx"
  
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    # WebSocket 支持
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    # 待办：使用 cert-manager 启用 TLS
    # cert-manager.io/cluster-issuer: letsencrypt-prod
  
  hosts:
    - host: openim.example.com  # 待办：替换为您的域名
      paths:
        - path: /
          pathType: Prefix
          backend:
            service:
              name: openim-api
              port: 10002
  
  # 待办：启用 TLS
  # tls:
  #   - secretName: openim-tls
  #     hosts:
  #       - openim.example.com

# ==============================================================================
# 监控和可观测性
# ==============================================================================
metrics:
  enabled: true
  serviceMonitor:
    enabled: false  # 如果使用 Prometheus Operator，设置为 true

# ==============================================================================
# 注意事项和待办：
# ==============================================================================
# 
# 重要提示：此配置假设：
# 1. Redpanda 安装在 'redpanda' 命名空间
# 2. Dragonfly 安装在 'dragonfly' 命名空间
# 3. SeaweedFS 安装在 'seaweedfs' 命名空间
# 4. 所有组件都可以通过内部 DNS 访问
#
# 无需修改代码：所有组件都使用标准 API：
# - Redpanda：Kafka API（完全兼容）
# - Dragonfly：Redis 协议（完全兼容）
# - SeaweedFS：S3 API（兼容 MinIO）
#
# 部署到生产环境前的待办事项：
# 1. 更改所有默认密码（MySQL、SeaweedFS）
# 2. 配置实际域名
# 3. 使用 cert-manager 启用 TLS/SSL
# 4. 为 Redpanda 和 Dragonfly 启用身份验证
# 5. 根据负载调整副本数和资源
# 6. 设置监控和告警
# 7. 配置数据库备份策略
# 8. 审查和调整资源限制
#
# 字段兼容性注意事项：
# - 此 values.yaml 基于 OpenIM Helm chart 结构
# - 实际字段名称可能因 chart 版本而异
# - 运行 `helm show values openim/openim-server` 来验证字段
# - 如果官方 chart 结构发生变化，请更新此文件
#
# PostgreSQL 支持：
# - OpenIM 官方支持 MySQL（此处默认）
# - PostgreSQL 支持是可能的，但需要：
#   * 在 OpenIM 配置中更改数据库驱动
#   * 测试架构兼容性
#   * 不建议在没有官方支持的情况下使用
# ==============================================================================
